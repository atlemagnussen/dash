# must use aspnet if libs have <FrameworkReference Include="Microsoft.AspNetCore.App" />
#FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
FROM mcr.microsoft.com/dotnet/runtime:8.0 AS base 

USER app
WORKDIR /app

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

COPY . .

ARG PUBLISH_FOLDER=/publish

WORKDIR "/src"
RUN dotnet restore "./Connector/DigiLean.Connector.WorkerService/DigiLean.Connector.WorkerService.csproj"
RUN dotnet build   "./Connector/DigiLean.Connector.WorkerService/DigiLean.Connector.WorkerService.csproj" -c Release --runtime linux-x64 -o build


FROM build AS publish
RUN dotnet publish "./Connector/DigiLean.Connector.WorkerService/DigiLean.Connector.WorkerService.csproj" -c Release --runtime linux-x64 -o ${PUBLISH_FOLDER} /p:UseAppHost=false

RUN .build/build-jobs.sh /jobs


FROM base AS final
WORKDIR /app
COPY --from=publish /publish .
COPY --from=publish /jobs/*.dll .
ENTRYPOINT ["dotnet", "DigiLean.Connector.WorkerService.dll"]